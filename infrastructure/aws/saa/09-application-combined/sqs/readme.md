# Amazon Simple Queue Service（SQS）
フルマネージドのメッセージキューイング*1サービス。

Amazon SQSはプル型なので、受信側の都合の良いタイミングでSQSへポーリング（*2問い合わせ）を行って、メッセージを受け取る。  
SQSでは、キュー内のメッセージは自動的に削除されず、受信側がメッセージを正常に処理した後にSQSキューから削除する。  
受信側の処理中にエラーが発生した場合は削除が実行されず、メッセージはSQSキューに残る。

*1 メッセージキューイングとは？  
個々のサービスやシステムを、メッセージを使用して連携する仕組みのことで、サービス同士の橋渡しを担う。  
*2 ポーリング（polling）  
機器などに対して、一定間隔で順番に問合せ（データの送信要求など）を行うこと。

## メリット
サービス間の結合度を低くできるため、以下のようなメリットがある。
* 関連するサービスの負荷や処理状況に引きずられずに、自身の処理を進行できる
* 関連するサービスで障害が発生した場合やアップデートなどの際に、影響を受けずに済む

## 標準キューとFIFOキュー
## ショートポーリングとロングポーリング
## 遅延キューとメッセージタイマー
## 可視性タイムアウト（Visibility Timeout）
キューのメッセージは、受信側が明示的に削除指示をしないと削除されません。SQSのメッセージを受信するクライアントが複数ある場合、タイミングによっては、メッセージが削除される前に複数のクライアントでメッセージを受信してしまうことがあります。  
可視性タイムアウトはこれを防ぐために、一度クライアントがメッセージを受信した後、指定時間（デフォルト30秒）が経過するまでそのメッセージが他のクライアントからは見えないようにします。

なお、可視性タイムアウトはデフォルトで有効になっています。

## アクセス制御
キューに対してアクセスポリシー（リソースベースのポリシー）を設定することができる。  
SQSアクセスポリシーは、特定のSQSキューに対するアクセス権を定義し、他のAWSアカウントからのアクセスも制御することが可能。  
適切なアクセスポリシーを設定することで、管理者はセキュアなメッセージキューの運用を実現できる。

## SQSとCloudWatch、Auto Scalingの連携
リクエストが急激に増加した場合、SQSとCloudWatch、Auto Scalingを連携することでサーバーを自動的にスケーリングできる。  
リクエストの増加によりSQSに滞留したメッセージ数（バックログ）がしきい値を超えたときに、CloudWatchがアラートを上げ、Auto Scalingがサーバーを増やす。  
キューにメッセージがなくなり次第スケールインすることで、コストを抑えた運用が実現できる。

## 配信失敗時のSQSデッドレターキューの利用
SNSでは、SNSトピックからメッセージの配信に失敗した場合、通常はメッセージを破棄している。  
メッセージの破棄を防ぐには、配信不能メッセージをAmazon SQSのデッドレターキューに送信するようにサブスクリプションを設定する。 

### 例
サブスクリプションがLambda関数の場合、デッドレターキューに保持されたメッセージをLambda関数がポーリングすることで、SNSトピックから配信された全てのメッセージがLambda関数で処理されるようになる。

