# Amazon CloudFront
Amazon CloudFrontは、AWS上で動作する安全で高速なコンテンツ配信ネットワークです。  
CloudFrontを利用すると、世界各地に配置されているエッジロケーションから、自動的にクライアントと地理的な距離が近いエッジロケーションが選択されます。  
そしてエッジロケーション内のエッジサーバーがコンテンツを配信します。
CloudFrontのオリジンサーバーには、EC2インスタンスやS3バケットなどのAWSリソースや、オンプレミスのサーバーを設定できます。

## エッジロケーション
AZとは異なるAWSデータセンターで、AZよりも数多く世界中に配置されています。Amazon CloudFrontやAWS WAFなど一部のグローバルサービスを提供するとともに、AWS Global Acceleratorを利用してユーザーからリージョンサービスへアクセスする際の通信経路でもあります。

## ディストリビューション
CloudFrontを使用するには、はじめに「ディストリビューション」を作成します。  
ディストリビューションではオリジンサーバーやキャッシュなど、コンテンツを配信するために必要な各種設定をします。  
ディストリビューションを作成するとCloudFrontを通してコンテンツにアクセスするためのURL「http(s)://xxxxxx.cloudfront.net」が発行されます。URLは通信の暗号化の有無（HTTP/HTTPS）を選択できます。AWS Certificate Manager（サーバー証明書を管理するサービス）から発行したサーバー証明書をインポートすることで、URLに独自ドメイン名を使用することもできます。

すでにS3の静的Webホスティング（バケットに保存している静的コンテンツをWebサイトとして公開できる機能）を設定しているS3バケットもオリジンサーバーとして指定できます。

### キャッシュの設定や機能
キャッシュには、CloudFrontのキャッシュとブラウザキャッシュの2種類があります。CloudFrontのキャッシュは「キャッシュポリシー」でTTL（Time To Live）を設定でき、ブラウザキャッシュは「Cache-Controlヘッダー」で制御できます。

#### ○キャッシュTTL（Time To Live:TTL）
キャッシュを保持する時間のことです。URLパスごとに指定できます。CloudFrontはキャッシュTTLが超過した後にクライアントからのリクエストを受けると、オリジンサーバーにコンテンツの更新有無を確認し、更新されていればキャッシュに反映しつつ応答を返します。
キャッシュTTLを含むキャッシュの設定のことを「キャッシュポリシー」といいます。

#### ○キャッシュ削除（Invalidation）
エッジサーバーに保存されているキャッシュを即座に削除できる機能です。キャッシュを削除した後にクライアントからデータのリクエストを受け取ると、エッジサーバーは必ずオリジンサーバーへコンテンツを取得しにいくので、クライアントへ配信するコンテンツが最新化されます。削除対象のデータはフォルダ名やファイル名で指定できます。

S3バケットを使用してWebコンテンツを保存する際、各オブジェクトに対してCache-Controlヘッダーを設定することで、ブラウザ（ローカル）キャッシュの動作を制御できます。S3オブジェクトのCache-Controlヘッダーをno-cacheに設定すると、ブラウザキャッシュが無効になりますが、CloudFrontのキャッシュには最小TTLが適用されます。最小TTLはデフォルトで1秒なので、コンテンツが変更された直後でも最新のコンテンツが返されます。

### CloudFront署名付きURL
URLを知っている特定のクライアントが期限付きでコンテンツへアクセスできる機能です。S3の署名付きURLと同じく、CloudFront署名付きURLは非常に長いランダムな文字列で作成されているため、URLを知らない人が推測することはほぼ不可能です。  
CloudFront署名付きURLを利用する時は、OAIを有効にしてS3バケットへ直接アクセスされないように設定します。また、URL発行時に有効期限を設定すると、有効期限の過ぎたURLは無効になります。

## Route 53でのルーティング
Route 53でCloudFrontにトラフィックをルーティングするようにDNSを設定することで、ユーザーから独自ドメインへのアクセスを適切にCloudFrontへ向けることができます。

つまりユーザーが直接オリジンサーバーへアクセスするのではなく、CloudFront経由でアクセスするように誘導できる。

## アクセスの流れ
1. ユーザーがCloudFront経由でアクセス
2. エッジサーバーに キャッシュがあれば、それを即座に返す（超高速）
3. キャッシュがなければ、オリジンサーバー（S3やEC2など）に取りに行く
4. そのデータをキャッシュに保存して、次回以降のリクエストに備える

